"""
Vulnerability DTO - Data Transfer Object for Vulnerabilities
"""

from typing import Optional, List
from pydantic import BaseModel, Field, validator


class VulnerabilityDTO(BaseModel):
    """DTO for vulnerability data validation and transfer."""
    
    # Required fields
    endpoint_id: str = Field(..., description="Parent endpoint ID")
    vuln_type: str = Field(..., description="Vulnerability type (SQLI, XSS, etc.)")
    
    # Status and confidence
    status: str = Field(default="POSSIBLE")
    confidence: float = Field(default=0.5, ge=0.0, le=1.0)
    
    # Evidence
    evidence: str = Field(default="", description="Evidence description")
    error_patterns: List[str] = Field(default_factory=list)
    
    # Testing info
    tested_by: str = Field(default="UNKNOWN")
    test_method: Optional[str] = Field(default=None)
    
    # CVSS-like scoring (optional)
    severity: str = Field(default="MEDIUM")
    
    @validator('vuln_type')
    def validate_vuln_type(cls, v):
        valid = ['SQLI', 'XSS', 'IDOR', 'AUTH_BYPASS', 'CODE_INJECTION', 'RCE', 'LFI', 'SSRF', 'BEHAVIORAL_ANOMALY', 'UNKNOWN']
        return v.upper() if v.upper() in valid else 'UNKNOWN'
    
    @validator('status')
    def validate_status(cls, v):
        valid = ['POSSIBLE', 'CONFIRMED_THEORETICAL', 'CONFIRMED_EXPLOITED', 'REJECTED', 'INCONCLUSIVE']
        return v.upper() if v.upper() in valid else 'POSSIBLE'
    
    @validator('severity')
    def validate_severity(cls, v):
        valid = ['LOW', 'MEDIUM', 'HIGH', 'CRITICAL']
        return v.upper() if v.upper() in valid else 'MEDIUM'
    
    def to_node(self, vuln_id: str) -> dict:
        """Convert to AssetGraph node format."""
        return {
            "id": vuln_id,
            "type": "VULNERABILITY",
            "properties": {
                "type": self.vuln_type,
                "status": self.status,
                "confidence": self.confidence,
                "evidence": self.evidence,
                "error_patterns": self.error_patterns,
                "tested_by": self.tested_by,
                "test_method": self.test_method,
                "severity": self.severity
            }
        }
    
    @classmethod
    def from_node(cls, node: dict, endpoint_id: str = "") -> "VulnerabilityDTO":
        """Create from AssetGraph node."""
        props = node.get("properties", {})
        return cls(
            endpoint_id=endpoint_id,
            vuln_type=props.get("type", "UNKNOWN"),
            status=props.get("status", "POSSIBLE"),
            confidence=props.get("confidence", 0.5),
            evidence=props.get("evidence", ""),
            error_patterns=props.get("error_patterns", []),
            tested_by=props.get("tested_by", "UNKNOWN"),
            test_method=props.get("test_method"),
            severity=props.get("severity", "MEDIUM")
        )
    
    class Config:
        extra = "ignore"
