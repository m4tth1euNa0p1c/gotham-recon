# Diagrammes d'Architecture - Recon Gotham v3.0

## 1. Vue d'Ensemble du Système

```
                                    ┌──────────────────┐
                                    │                  │
                                    │   GOTHAM-UI      │
                                    │   (Next.js)      │
                                    │   Port 3000      │
                                    │                  │
                                    └────────┬─────────┘
                                             │
                                             │ GraphQL / WebSocket / SSE
                                             ▼
┌────────────────────────────────────────────────────────────────────────────────┐
│                                                                                 │
│                            BFF GATEWAY (FastAPI)                                │
│                         Strawberry GraphQL + REST                               │
│                              Port 8080                                          │
│                                                                                 │
└─────┬──────────────────────┬──────────────────────┬──────────────────────┬─────┘
      │                      │                      │                      │
      │ HTTP                 │ HTTP                 │ Kafka                │ HTTP
      ▼                      ▼                      ▼                      ▼
┌───────────┐         ┌───────────┐         ┌───────────┐         ┌───────────────┐
│           │         │           │         │           │         │               │
│ORCHESTRAT.│◄───────►│  GRAPH    │◄───────►│  KAFKA    │◄───────►│ PHASE         │
│  8000     │         │ SERVICE   │         │  9092     │         │ SERVICES      │
│           │         │  8001     │         │           │         │ 8002-8007     │
└─────┬─────┘         └─────┬─────┘         └───────────┘         └───────┬───────┘
      │                     │                                             │
      │                     │ SQLite                                      │
      ▼                     ▼                                             ▼
┌───────────┐         ┌───────────┐                               ┌───────────────┐
│PostgreSQL │         │  SQLite   │                               │SCANNER PROXY  │
│   5432    │         │   DB      │                               │ 8051/50051    │
└───────────┘         └───────────┘                               └───────────────┘
```

---

## 2. Pipeline de Mission

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           MISSION PIPELINE                                       │
│                                                                                  │
│    ┌─────────────┐                                                              │
│    │   START     │                                                              │
│    │  MISSION    │                                                              │
│    └──────┬──────┘                                                              │
│           │                                                                      │
│           ▼                                                                      │
│    ┌─────────────────────────────────────────────────────────────────────────┐  │
│    │                        PHASE 1: OSINT                                    │  │
│    │  ┌───────────┐   ┌───────────┐   ┌───────────┐   ┌───────────────────┐  │  │
│    │  │Pathfinder │──▶│Watchtower │──▶│StackTrace │──▶│    DeepScript     │  │  │
│    │  │(Subfinder)│   │   (DNS)   │   │  (HTTPX)  │   │    (JS Mining)    │  │  │
│    │  └───────────┘   └───────────┘   └───────────┘   └───────────────────┘  │  │
│    └─────────────────────────────────────────────────────────────────────────┘  │
│           │                                                                      │
│           ▼                                                                      │
│    ┌─────────────────────────────────────────────────────────────────────────┐  │
│    │                      SAFETY NET (Gate Check)                             │  │
│    │           subdomains == 0 ? ──▶ Fallback Apex + www                     │  │
│    └─────────────────────────────────────────────────────────────────────────┘  │
│           │                                                                      │
│           ▼                                                                      │
│    ┌─────────────────────────────────────────────────────────────────────────┐  │
│    │                     PHASE 3: ACTIVE RECON                                │  │
│    │  ┌────────────────┐   ┌────────────────┐   ┌────────────────────────┐   │  │
│    │  │  HTTPX Probe   │──▶│  HTML Crawler  │──▶│   Wayback Endpoints    │   │  │
│    │  │  (All Subs)    │   │ (Live Services)│   │   (Historical URLs)    │   │  │
│    │  └────────────────┘   └────────────────┘   └────────────────────────┘   │  │
│    └─────────────────────────────────────────────────────────────────────────┘  │
│           │                                                                      │
│           ▼                                                                      │
│    ┌─────────────────────────────────────────────────────────────────────────┐  │
│    │                   PHASE 23: ENDPOINT INTEL                               │  │
│    │  ┌────────────────────────────────────────────────────────────────────┐ │  │
│    │  │  For each endpoint:                                                 │ │  │
│    │  │    • Categorize (API, ADMIN, AUTH, LEGACY, STATIC)                 │ │  │
│    │  │    • Extract parameters                                             │ │  │
│    │  │    • Compute risk score (0-100)                                     │ │  │
│    │  │    • Generate hypotheses (IDOR, SQLI, XSS, etc.)                   │ │  │
│    │  └────────────────────────────────────────────────────────────────────┘ │  │
│    └─────────────────────────────────────────────────────────────────────────┘  │
│           │                                                                      │
│           ▼                                                                      │
│    ┌─────────────────────────────────────────────────────────────────────────┐  │
│    │                  PHASE 24: VALIDATION                                    │  │
│    │  ┌────────────────────────────────────────────────────────────────────┐ │  │
│    │  │  • Validate reachability of endpoints                               │ │  │
│    │  │  • Deep page analysis (forms, APIs, auth)                          │ │  │
│    │  │  • Technology detection                                             │ │  │
│    │  └────────────────────────────────────────────────────────────────────┘ │  │
│    └─────────────────────────────────────────────────────────────────────────┘  │
│           │                                                                      │
│           ▼                                                                      │
│    ┌─────────────────────────────────────────────────────────────────────────┐  │
│    │                  PHASE 25: VERIFICATION                                  │  │
│    │  ┌────────────────────────────────────────────────────────────────────┐ │  │
│    │  │  • Stack classification                                             │ │  │
│    │  │  • Security testing on high-risk endpoints                          │ │  │
│    │  │  • Materialize vulnerabilities from hypotheses                      │ │  │
│    │  └────────────────────────────────────────────────────────────────────┘ │  │
│    └─────────────────────────────────────────────────────────────────────────┘  │
│           │                                                                      │
│           ▼                                                                      │
│    ┌─────────────────────────────────────────────────────────────────────────┐  │
│    │                     REPORTING                                            │  │
│    │  ┌───────────────┐ ┌───────────────┐ ┌───────────────┐ ┌─────────────┐  │  │
│    │  │ asset_graph   │ │   summary     │ │   metrics     │ │  live.log   │  │  │
│    │  │    .json      │ │     .md       │ │     .json     │ │             │  │  │
│    │  └───────────────┘ └───────────────┘ └───────────────┘ └─────────────┘  │  │
│    └─────────────────────────────────────────────────────────────────────────┘  │
│           │                                                                      │
│           ▼                                                                      │
│    ┌─────────────┐                                                              │
│    │   MISSION   │                                                              │
│    │  COMPLETED  │                                                              │
│    └─────────────┘                                                              │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. Architecture du Graph Service

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           GRAPH SERVICE (CQRS)                                   │
│                                                                                  │
│    ┌─────────────────────────────────────────────────────────────────────────┐  │
│    │                          WRITE PATH (Commands)                           │  │
│    │                                                                          │  │
│    │   API Request                                                            │  │
│    │       │                                                                  │  │
│    │       ▼                                                                  │  │
│    │  ┌───────────┐    ┌───────────┐    ┌───────────┐    ┌───────────────┐   │  │
│    │  │  Router   │───▶│ Validator │───▶│  Writer   │───▶│   SQLite DB   │   │  │
│    │  │ (FastAPI) │    │   (DTO)   │    │  Service  │    │   (Persist)   │   │  │
│    │  └───────────┘    └───────────┘    └─────┬─────┘    └───────────────┘   │  │
│    │                                          │                               │  │
│    │                                          ▼                               │  │
│    │                                   ┌───────────────┐                      │  │
│    │                                   │ Kafka Producer│                      │  │
│    │                                   │ (Emit Event)  │                      │  │
│    │                                   └───────────────┘                      │  │
│    └─────────────────────────────────────────────────────────────────────────┘  │
│                                                                                  │
│    ┌─────────────────────────────────────────────────────────────────────────┐  │
│    │                          READ PATH (Queries)                             │  │
│    │                                                                          │  │
│    │   API Request                                                            │  │
│    │       │                                                                  │  │
│    │       ▼                                                                  │  │
│    │  ┌───────────┐    ┌───────────────┐    ┌───────────────────────────┐    │  │
│    │  │  Router   │───▶│ Query Builder │───▶│         SQLite            │    │  │
│    │  │ (FastAPI) │    │   (Filters)   │    │  (Optimized Reads)        │    │  │
│    │  └───────────┘    └───────────────┘    └───────────────────────────┘    │  │
│    │                                                                          │  │
│    └─────────────────────────────────────────────────────────────────────────┘  │
│                                                                                  │
│    ┌─────────────────────────────────────────────────────────────────────────┐  │
│    │                          EVENT PATH (WebSocket)                          │  │
│    │                                                                          │  │
│    │  ┌───────────────┐    ┌───────────────┐    ┌───────────────────────┐    │  │
│    │  │Kafka Consumer │───▶│ Event Router  │───▶│  WebSocket Clients    │    │  │
│    │  │ (Subscribe)   │    │  (by mission) │    │  (Real-time updates)  │    │  │
│    │  └───────────────┘    └───────────────┘    └───────────────────────┘    │  │
│    │                                                                          │  │
│    └─────────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. Modèle de Données (Asset Graph)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           ASSET GRAPH MODEL                                      │
│                                                                                  │
│                              ┌──────────────┐                                   │
│                              │    DOMAIN    │                                   │
│                              │ example.com  │                                   │
│                              └──────┬───────┘                                   │
│                                     │                                           │
│                                     │ HAS_SUBDOMAIN                             │
│                                     ▼                                           │
│                     ┌───────────────────────────────┐                          │
│                     │          SUBDOMAIN             │                          │
│                     │  ┌─────────┐  ┌─────────────┐ │                          │
│                     │  │  www    │  │   api       │ │                          │
│                     │  └────┬────┘  └──────┬──────┘ │                          │
│                     └───────┼──────────────┼────────┘                          │
│                             │              │                                    │
│                   RESOLVES_TO│              │RESOLVES_TO                        │
│                             ▼              ▼                                    │
│                     ┌───────────────────────────────┐                          │
│                     │         IP_ADDRESS             │                          │
│                     │  ┌──────────┐ ┌─────────────┐ │                          │
│                     │  │192.168.1 │ │ 192.168.2   │ │                          │
│                     │  └──────────┘ └─────────────┘ │                          │
│                     └───────────────────────────────┘                          │
│                                                                                  │
│  ┌─────────┐    EXPOSES_HTTP    ┌───────────────┐    EXPOSES_ENDPOINT          │
│  │SUBDOMAIN│──────────────────▶ │ HTTP_SERVICE  │─────────────────────────┐    │
│  │  www    │                    │https://www... │                         │    │
│  └─────────┘                    └───────────────┘                         │    │
│                                                                           ▼    │
│                                                              ┌──────────────┐  │
│                                                              │   ENDPOINT   │  │
│                                                              │ /api/v1/users│  │
│                                                              └──────┬───────┘  │
│                                                                     │          │
│                                             ┌───────────────────────┼─────┐    │
│                                             │                       │     │    │
│                                     HAS_PARAM│              HAS_HYPOTHESIS│     │
│                                             ▼                       ▼     │    │
│                                   ┌───────────────┐       ┌─────────────┐│    │
│                                   │   PARAMETER   │       │ HYPOTHESIS  ││    │
│                                   │   id (path)   │       │    IDOR     ││    │
│                                   └───────────────┘       └─────────────┘│    │
│                                                                          │    │
│                                                              HAS_VULNERABILITY │
│                                                                          │    │
│                                                                          ▼    │
│                                                              ┌──────────────┐  │
│                                                              │VULNERABILITY │  │
│                                                              │ CVE-2024-xxx │  │
│                                                              └──────────────┘  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. Workflow Nodes (Agent Execution)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        WORKFLOW VISUALIZATION                                    │
│                                                                                  │
│    ┌─────────────────────────────────────────────────────────────────────────┐  │
│    │                        AGENT_RUN: Pathfinder                             │  │
│    │    ┌────────────────────────────────────────────────────────────────┐   │  │
│    │    │ status: completed | duration: 45s | phase: OSINT               │   │  │
│    │    └────────────────────────────────────────────────────────────────┘   │  │
│    │                              │                                           │  │
│    │                              │ USES_TOOL                                 │  │
│    │              ┌───────────────┼───────────────┐                          │  │
│    │              ▼               ▼               ▼                          │  │
│    │    ┌──────────────┐ ┌──────────────┐ ┌──────────────┐                   │  │
│    │    │  TOOL_CALL   │ │  TOOL_CALL   │ │  TOOL_CALL   │                   │  │
│    │    │  subfinder   │ │    dns       │ │   wayback    │                   │  │
│    │    │  result: 48  │ │  result: 12  │ │  result: 156 │                   │  │
│    │    └──────┬───────┘ └──────┬───────┘ └──────┬───────┘                   │  │
│    │           │                │                │                            │  │
│    │           │ PRODUCES       │ PRODUCES       │ PRODUCES                   │  │
│    │           ▼                ▼                ▼                            │  │
│    │    ┌──────────────┐ ┌──────────────┐ ┌──────────────┐                   │  │
│    │    │ 48 SUBDOMAIN │ │12 DNS_RECORD │ │156 ENDPOINT  │                   │  │
│    │    │    nodes     │ │    nodes     │ │    nodes     │                   │  │
│    │    └──────────────┘ └──────────────┘ └──────────────┘                   │  │
│    └─────────────────────────────────────────────────────────────────────────┘  │
│                              │                                                  │
│                              │ TRIGGERS                                         │
│                              ▼                                                  │
│    ┌─────────────────────────────────────────────────────────────────────────┐  │
│    │                        AGENT_RUN: Watchtower                             │  │
│    │    ┌────────────────────────────────────────────────────────────────┐   │  │
│    │    │ status: completed | duration: 12s | phase: OSINT               │   │  │
│    │    └────────────────────────────────────────────────────────────────┘   │  │
│    │                              │                                           │  │
│    │                              │ USES_TOOL                                 │  │
│    │                              ▼                                           │  │
│    │                     ┌──────────────┐                                     │  │
│    │                     │  TOOL_CALL   │                                     │  │
│    │                     │dns_resolver  │                                     │  │
│    │                     │  result: 48  │                                     │  │
│    │                     └──────────────┘                                     │  │
│    └─────────────────────────────────────────────────────────────────────────┘  │
│                              │                                                  │
│                              │ TRIGGERS                                         │
│                              ▼                                                  │
│    ┌─────────────────────────────────────────────────────────────────────────┐  │
│    │                        AGENT_RUN: StackTrace                             │  │
│    │    ...                                                                   │  │
│    └─────────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. Event Flow (Kafka)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           KAFKA EVENT FLOW                                       │
│                                                                                  │
│    ┌─────────────────────────────────────────────────────────────────────────┐  │
│    │                      TOPIC: graph.events                                 │  │
│    │    Partitions: 3 | Replication: 1                                       │  │
│    │                                                                          │  │
│    │  Events:                                                                 │  │
│    │    • NODE_ADDED      { node_id, type, properties }                      │  │
│    │    • NODE_UPDATED    { node_id, changes }                               │  │
│    │    • NODE_DELETED    { node_id }                                        │  │
│    │    • EDGE_ADDED      { from_node, to_node, edge_type }                  │  │
│    │    • EDGE_DELETED    { edge_id }                                        │  │
│    │    • ATTACK_PATH_ADDED { target, score, actions }                       │  │
│    └─────────────────────────────────────────────────────────────────────────┘  │
│                                                                                  │
│    ┌─────────────────────────────────────────────────────────────────────────┐  │
│    │                      TOPIC: logs.recon                                   │  │
│    │    Partitions: 3 | Replication: 1                                       │  │
│    │                                                                          │  │
│    │  Events:                                                                 │  │
│    │    • LOG             { level, phase, message, metadata }                │  │
│    │    • AGENT_STARTED   { agent_id, task, phase }                          │  │
│    │    • AGENT_FINISHED  { agent_id, result, duration }                     │  │
│    │    • TOOL_CALLED     { tool_name, arguments }                           │  │
│    │    • TOOL_FINISHED   { tool_name, result, duration }                    │  │
│    └─────────────────────────────────────────────────────────────────────────┘  │
│                                                                                  │
│    ┌─────────────────────────────────────────────────────────────────────────┐  │
│    │                      TOPIC: mission.state                                │  │
│    │    Partitions: 1 | Replication: 1                                       │  │
│    │                                                                          │  │
│    │  Events:                                                                 │  │
│    │    • MISSION_CREATED  { mission_id, target_domain, mode }               │  │
│    │    • PHASE_STARTED    { mission_id, phase }                             │  │
│    │    • PHASE_COMPLETED  { mission_id, phase, metrics }                    │  │
│    │    • MISSION_COMPLETED { mission_id, summary }                          │  │
│    │    • MISSION_FAILED   { mission_id, error }                             │  │
│    └─────────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. Frontend Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           GOTHAM-UI ARCHITECTURE                                 │
│                                                                                  │
│    ┌─────────────────────────────────────────────────────────────────────────┐  │
│    │                        APP ROUTER (Next.js 14)                           │  │
│    │                                                                          │  │
│    │    /                    → Dashboard (Mission List)                       │  │
│    │    /history             → Mission History                                │  │
│    │    /targets             → Target Management                              │  │
│    │    /reports             → Report Downloads                               │  │
│    │    /analytics           → Statistics & Analytics                         │  │
│    │    /settings            → Application Settings                           │  │
│    │    /mission/[id]        → Mission Details                                │  │
│    │    /mission/[id]/workflow → Workflow Visualization                       │  │
│    │    /mission/[id]/graph  → Asset Graph View                               │  │
│    │    /mission/[id]/vulnerabilities → Security Findings                     │  │
│    │                                                                          │  │
│    └─────────────────────────────────────────────────────────────────────────┘  │
│                                                                                  │
│    ┌─────────────────────────────────────────────────────────────────────────┐  │
│    │                         ZUSTAND STORES                                   │  │
│    │                                                                          │  │
│    │    missionStore      │ currentMission, missions, fetchMission()         │  │
│    │    graphStore        │ nodes, edges, fetchGraph(), subscribe()          │  │
│    │    workflowStore     │ agentRuns, toolCalls, selectedNode               │  │
│    │    uiStore           │ theme, sidebarOpen, notifications                │  │
│    │                                                                          │  │
│    └─────────────────────────────────────────────────────────────────────────┘  │
│                                                                                  │
│    ┌─────────────────────────────────────────────────────────────────────────┐  │
│    │                         COMPONENTS                                       │  │
│    │                                                                          │  │
│    │    /dashboard                                                            │  │
│    │      ├── Sidebar.tsx          → Navigation sidebar                       │  │
│    │      ├── MissionCard.tsx      → Mission summary card                     │  │
│    │      └── StatsOverview.tsx    → Statistics widgets                       │  │
│    │                                                                          │  │
│    │    /workflow                                                             │  │
│    │      ├── WorkflowHierarchy.tsx → Main workflow graph                     │  │
│    │      ├── AgentPipeline.tsx    → Agent execution timeline                 │  │
│    │      ├── TracePanel.tsx       → Event trace sidebar                      │  │
│    │      ├── WorkflowControls.tsx → Playback controls                        │  │
│    │      └── AssetMap.tsx         → Asset overview                           │  │
│    │                                                                          │  │
│    │    /assets                                                               │  │
│    │      ├── AssetGraph.tsx       → React Flow graph                         │  │
│    │      ├── NodePanel.tsx        → Node details panel                       │  │
│    │      └── AssetTable.tsx       → Tabular asset view                       │  │
│    │                                                                          │  │
│    └─────────────────────────────────────────────────────────────────────────┘  │
│                                                                                  │
│    ┌─────────────────────────────────────────────────────────────────────────┐  │
│    │                         PROVIDERS                                        │  │
│    │                                                                          │  │
│    │    LiveStreamProvider                                                    │  │
│    │      ├── connect(missionId)  → Start SSE/WebSocket connection           │  │
│    │      ├── disconnect()        → Close connection                          │  │
│    │      ├── status              → 'connecting' | 'connected' | 'error'     │  │
│    │      └── loadHistoricalData() → Load past mission data                  │  │
│    │                                                                          │  │
│    └─────────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 8. Deployment Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        DOCKER COMPOSE DEPLOYMENT                                 │
│                                                                                  │
│    ┌─────────────────────────────────────────────────────────────────────────┐  │
│    │                         NETWORK: gotham-network                          │  │
│    │                                                                          │  │
│    │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │  │
│    │  │  gotham-ui  │  │bff-gateway  │  │orchestrator │  │graph-service│    │  │
│    │  │   :3000     │  │   :8080     │  │   :8000     │  │   :8001     │    │  │
│    │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘    │  │
│    │                                                                          │  │
│    │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │  │
│    │  │osint-runner │  │active-recon │  │endpoint-intel│  │verification│    │  │
│    │  │   :8002     │  │   :8003     │  │   :8004     │  │   :8005     │    │  │
│    │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘    │  │
│    │                                                                          │  │
│    │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │  │
│    │  │  reporter   │  │   planner   │  │scanner-proxy│  │   kafka     │    │  │
│    │  │   :8006     │  │   :8007     │  │:8051/:50051 │  │   :9092     │    │  │
│    │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘    │  │
│    │                                                                          │  │
│    │  ┌─────────────┐  ┌─────────────┐                                       │  │
│    │  │ postgresql  │  │   ollama    │                                       │  │
│    │  │   :5432     │  │   :11434    │                                       │  │
│    │  └─────────────┘  └─────────────┘                                       │  │
│    │                                                                          │  │
│    └─────────────────────────────────────────────────────────────────────────┘  │
│                                                                                  │
│    ┌─────────────────────────────────────────────────────────────────────────┐  │
│    │                         VOLUMES                                          │  │
│    │                                                                          │  │
│    │    postgres_data      → /var/lib/postgresql/data                        │  │
│    │    graph_data         → /app/data (SQLite DB)                           │  │
│    │    ollama_data        → /root/.ollama                                   │  │
│    │    output             → /app/output (Reports)                           │  │
│    │                                                                          │  │
│    └─────────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────────┘
```
